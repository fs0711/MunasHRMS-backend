{% extends 'index.html' %}
{% block scripthead %}

<script>
    response_code = parseInt("{{response_code}}")
    response_message = "{{response_message}}"
    {% if response_code == 200 %}
    console.log({{response_data|tojson}})
    phone_numbers = `{{response_data[0]['cp_contact_number']|tojson}}`
    // document.location = "/home"
    // alert(`Lead Added \n` + `{{ response_data| tojson}}`)
    {% endif %}
    {% if response_code == 4003 %}
    alert(`Validation Failed - Please recheck submitted data\n` + `{{ response_data| tojson}}`)
    console.log({{ response_data| tojson}})
    {% elif response_code != 200 %}
    // alert(`Error \n` + `{{ response_message}}`)
    {% endif %}
</script>
{% endblock %}
{% block content %}





<!-- ============================================================== -->
<!-- Start right Content here -->
<!-- ============================================================== -->
<div class="content-page">
    <!-- Start content -->
    <div class="content">
        <div class="container">


            <div class="row">
                <div class="col-xs-12">
                    <div class="page-title-box">
                        <h4 class="page-title">Edit Organizations</h4>
                        <div class="clearfix"></div>
                    </div>
                </div>
            </div>
            <!-- end row -->


            <div class="row">
                <div class=" col-sm-12">
                    <form id="addLeadForm" class="form-horizontal">
                    <div class="card-box">
                        <div class="row">
                            <input type="hidden" class="form-control" name="id"
                                placeholder="id" value="{{response_data[0].id}}" required>
                            <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="col-md-2 control-label">Organization Name*</label>
                                        <div class="col-md-10">
                                            <input type="text" class="form-control" name="name"
                                                placeholder="Organization Name" value="{{response_data[0].name}}" required>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-md-2 control-label">CP Name*</label>
                                        <div class="col-md-10">
                                            <input type="text" class="form-control" name="cp_name" placeholder="Contact Person Name" value="{{response_data[0].cp_name}}" required>
                                        </div>
                                    </div>
                                    <div id="phone-section" required>

                                </div>
                                    <div class="form-group">
                                        <a href="#" id="addbtn">
                                        <i class="mdi mdi-plus-circle-outline"> </i></a>
                                    </div>

                                    <div class="form-group">
                                        <label class="col-md-2 control-label">CP Email*</label>
                                        <div class="col-md-10">
                                            <input type="email" class="form-control" name="cp_email"
                                                placeholder="Contact Person Email" value="{{response_data[0].cp_email}}" required>
                                        </div>
                                    </div>
                            </div>

                            <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="col-md-2 control-label">Address*</label>
                                        <div class="col-md-10">
                                            <input type="text" class="form-control" name="address"
                                                placeholder="Address" value="{{response_data[0].address}}" required>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-md-2 control-label">City*</label>
                                        <div class="col-md-10">
                                            <input type="text" class="form-control" name="city" placeholder="City" value="{{response_data[0].city}}" required>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-md-2 control-label">Country*</label>
                                        <div class="col-md-10">
                                            <input type="text" class="form-control" name="country"
                                                placeholder="Country" value="{{response_data[0].country}}" required>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-md-2 control-label">NTN</label>
                                        <div class="col-md-10">
                                            <input type="text" class="form-control" name="ntn"
                                                placeholder="National Tax Number" value="{{response_data[0].ntn}}">
                                        </div>
                                    </div>
                            </div>
                        </div>
                    </div>

                    <div class ="text-right">
                        <button class="text-right btn btn-success">Save</button>
                    </div>
                </div>
            </div>
            <!-- end row -->
        </div> <!-- container -->

    </div> <!-- content -->



</div>

<script>
    var phoneFieldCount = 0;
    var phoneFieldObjects = [];
    phone_numbers = phone_numbers.replace("[","")
    phone_numbers = phone_numbers.replace("]","")
    phone_numbers = phone_numbers.replaceAll('"',"")
    phone_numbers = phone_numbers.split(",")
    for (var numbers in phone_numbers) {
        phoneFieldCount += 1;
        $('#phone-section').append(`                                   
            <div id="phone${phoneFieldCount}" class="form-group">
            <label class="col-md-2 control-label">Phone Number</label>
            <div class="col-md-10">
                <input id="phoneField${phoneFieldCount}" type="text" class="form-control">
                <a href="javascript:removebtn(${phoneFieldCount})" id="removebtn" style="font-size: 20px">
                                        <i class="mdi mdi-close-circle-outline"></i></a>
            </div>
            </div>`)
        var input = document.querySelector("#phoneField" + phoneFieldCount);
        phoneFieldObjects.push( window.intlTelInput(input, {
            autoPlaceholder:"polite",
            formatOnDisplay:true,
            initialCountry:"pk",
            placeholderNumberType:"MOBILE",
            preferredCountries: ["pk","ae","sa","us","gb" ],
            utilsScript: "{{ url_for('static', filename='js/utils.js') }}",
            separateDialCode:true,
        }));
        phoneFieldObjects[phoneFieldCount-1].setNumber(phone_numbers[numbers])
    };

    function removebtn(ref){
        $("#phone" + ref).remove();
        delindex = phoneFieldObjects.findIndex((field) => field.id==ref)
        phoneFieldObjects.splice((delindex-1),1)
    };

    $('#addbtn').click(function () {
        phoneFieldCount += 1;
        $('#phone-section').append(`                                   
            <div id="phone${phoneFieldCount}" class="form-group">
            <label class="col-md-2 control-label">Phone Number</label>
            <div class="col-md-10">
                <input id="phoneField${phoneFieldCount}" type="text" class="form-control">
                <a href="javascript:removebtn(${phoneFieldCount})" id="removebtn" style="font-size: 20px">
                                        <i class="mdi mdi-close-circle-outline"></i></a>
            </div>
            </div>`)
        var input = document.querySelector("#phoneField" + phoneFieldCount);
        phoneFieldObjects.push( window.intlTelInput(input, {
            autoPlaceholder:"polite",
            formatOnDisplay:true,
            initialCountry:"pk",
            placeholderNumberType:"MOBILE",
            preferredCountries: ["pk","ae","sa","us","gb" ],
            utilsScript: "{{ url_for('static', filename='js/utils.js') }}",
            separateDialCode:true,
        }));
        console.log(phoneFieldObjects);
    });

    const addLeadFormDOM = $("#addLeadForm")
    addLeadFormDOM.submit(function (event) {
        event.preventDefault();
        let formData = {}
        addLeadFormDOM.serializeArray().forEach(({ name, value }) => name !== "phone_number" ? formData[name] = value : formData[name] = [...(formData[name] || [] ), value] )
        var numbers = [];
        for (let i = 0; i < phoneFieldObjects.length; i++) {
            numbers.push(phoneFieldObjects[i].getNumber())
        }
        formData["cp_contact_number"] = numbers;
        console.log("formData",formData);
        $.ajax("/api/organizations/update", {
        method: "POST",
        data: JSON.stringify(formData),
        contentType: "application/json",
        success: function (data) {
            // console.log("data", data)
            if (data.response_code == 200) {
                alert('Organization Edited Successfully')
                setTimeout(function () {// wait for 5 secs(2)
                location.reload(); // then reload the page.(3)
                }, 300);
            }
            else {}
        },
        error: function (error) {
            console.log(error, "error");

        }
        });
    });
        
</script>
{% endblock %}