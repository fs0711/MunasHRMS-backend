{% extends 'index.html' %}
{% block scripthead %}

<script>
    response_code = parseInt("{{response_code}}")
    response_message = "{{response_message}}"
    {% if response_code == 200 %}
    console.log({{response_data|tojson}})
    phone_numbers = `{{response_data['data'][0]['phone_number']|tojson}}`
    // document.location = "/home"
    {% endif %}
    {% if response_code == 4003 %}
    alert(`Validation Failed - Please recheck submitted data\n` + `{{ response_data| tojson}}`)
    console.log({{ response_data| tojson}})
    {% elif response_code != 200 %}
    // alert(`Error \n` + `{{ response_message}}`)
    {% endif %}
</script>
{% endblock %}
{% block content %}





<!-- ============================================================== -->
<!-- Start right Content here -->
<!-- ============================================================== -->
<div class="content-page">
    <!-- Start content -->
    <div class="content">
        <div class="container">


            <div class="row">
                <div class="col-xs-12">
                    <div class="page-title-box">
                        <h4 class="page-title">Edit Lead</h4>
                        <div class="clearfix"></div>
                    </div>
                </div>
            </div>
            <!-- end row -->


            <div class="row">
                <div class=" col-sm-12">
                    <form id="addLeadForm" class="form-horizontal">
                    <div class="card-box">
                        <div class="row">
                            <div class="col-md-6">
                                    <div class="form-group">
                                        
                                            <input type="hidden" class="form-control" name="id"
                                                 value="{{response_data['data'][0]['id']}}" hidden>
                                        
                                        <label class="col-md-2 control-label">Name*</label>
                                        <div class="col-md-10">
                                            <input type="text" class="form-control" name="first_name"
                                                placeholder="First Name" value="{{response_data['data'][0]['first_name']}}" required>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-md-2 control-label">CNIC Number</label>
                                        <div class="col-md-10">
                                            <input type="text" class="form-control" name="nic" placeholder="NIC" value="{{response_data['data'][0]['nic']}}">
                                        </div>
                                    </div>
                                    <div id="phone-section">

                                    </div>
                                    <div class="form-group">
                                        <a href="#" id="addbtn">
                                        <i class="mdi mdi-plus-circle-outline"></i></a>
                                    </div>
                            </div>

                            <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="col-md-2 control-label">Address</label>
                                        <div class="col-md-10">
                                            <input type="text" class="form-control" name="address" value="{{response_data['data'][0]['address']}}"
                                                placeholder="Address">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-md-2 control-label">City*</label>
                                        <div class="col-md-10">
                                            <input type="text" class="form-control" name="city" placeholder="City" value="{{response_data['data'][0]['city']}}" required>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-md-2 control-label">Country*</label>
                                        <div class="col-md-10">
                                            <input type="text" class="form-control" name="country" value="{{response_data['data'][0]['country']}}"
                                                placeholder="Country" required>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">Gender*</label>
                                        <div class="col-sm-10">
                                            <select class="form-control" required name="gender" title="gender" value="{{response_data['data'][0]['gender']}}" required>
                                                <option value="{{response_data['data'][0]['gender']}}">{{response_data['data'][0]['gender']}}</option>
                                                <option value="Male">Male</option>
                                                <option value="Female">Female</option>
                                            </select>
                                        </div>
                                    </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class ="text-right">
                        <button class="text-right btn btn-success">Save</button>
                    </div>
                </div>
            </div>
            <!-- end row -->
        </div> <!-- container -->

    </div> <!-- content -->



</div>
<script>
    $(".datetime-picker").datetimepicker({
        format: 'YYYY-MM-DD hh:mm:ss'
    })

    var d = new Date();
    var month = d.getMonth()+1;
    var day = d.getDate();
    var hour = d.getHours();
    var minute = d.getMinutes();
    var second = d.getSeconds();

    var output = d.getFullYear() + '-' +
        ((''+month).length<2 ? '0' : '') + month + '-' +
        ((''+day).length<2 ? '0' : '') + day + ' ' +
        ((''+hour).length<2 ? '0' :'') + hour + ':' +
        ((''+minute).length<2 ? '0' :'') + minute + ':' +
        ((''+second).length<2 ? '0' :'') + second;
        
        $("#today").append(output);
        $("#radio").attr('value', output);
        var day = d.getDate()-1;

        var output = d.getFullYear() + '-' +
            ((''+month).length<2 ? '0' : '') + month + '-' +
            ((''+day).length<2 ? '0' : '') + day + ' ' +
            ((''+hour).length<2 ? '0' :'') + hour + ':' +
            ((''+minute).length<2 ? '0' :'') + minute + ':' +
            ((''+second).length<2 ? '0' :'') + second;
        
    $("#yesterday").append(output);
    $("#radio1").attr('value', output);

    var phoneFieldCount = 0;
    var phoneFieldObjects = [];
    phone_numbers = phone_numbers.replace("[","")
    phone_numbers = phone_numbers.replace("]","")
    phone_numbers = phone_numbers.replaceAll('"',"")
    phone_numbers = phone_numbers.split(",")
    for (var numbers in phone_numbers) {
        phoneFieldCount += 1;
        $('#phone-section').append(`                                   
            <div id="phone${phoneFieldCount}" class="form-group">
            <label class="col-md-2 control-label">Phone Number</label>
            <div class="col-md-10">
                <input id="phoneField${phoneFieldCount}" type="text" class="form-control">
                <a href="javascript:removebtn(${phoneFieldCount})" id="removebtn" style="font-size: 20px">
                                        <i class="mdi mdi-close-circle-outline"></i></a>
            </div>
            </div>`)
        var input = document.querySelector("#phoneField" + phoneFieldCount);
        phoneFieldObjects.push( window.intlTelInput(input, {
            autoPlaceholder:"polite",
            formatOnDisplay:true,
            initialCountry:"pk",
            placeholderNumberType:"MOBILE",
            preferredCountries: ["pk","ae","sa","us","gb" ],
            utilsScript: "{{ url_for('static', filename='js/utils.js') }}",
            separateDialCode:true,
        }));
        phoneFieldObjects[phoneFieldCount-1].setNumber(phone_numbers[numbers])
    };

    function removebtn(ref){
        $("#phone" + ref).remove();
        delindex = phoneFieldObjects.findIndex((field) => field.id==ref)
        phoneFieldObjects.splice((delindex-1),1)
    };

    $('#addbtn').click(function () {
        phoneFieldCount += 1;
        $('#phone-section').append(`                                   
            <div id="phone${phoneFieldCount}" class="form-group">
            <label class="col-md-2 control-label">Phone Number</label>
            <div class="col-md-10">
                <input id="phoneField${phoneFieldCount}" type="text" class="form-control">
                <a href="javascript:removebtn(${phoneFieldCount})" id="removebtn" style="font-size: 20px">
                                        <i class="mdi mdi-close-circle-outline"></i></a>
            </div>
            </div>`)
        var input = document.querySelector("#phoneField" + phoneFieldCount);
        phoneFieldObjects.push( window.intlTelInput(input, {
            autoPlaceholder:"polite",
            formatOnDisplay:true,
            initialCountry:"pk",
            placeholderNumberType:"MOBILE",
            preferredCountries: ["pk","ae","sa","us","gb" ],
            utilsScript: "{{ url_for('static', filename='js/utils.js') }}",
            separateDialCode:true,
        }));
        console.log(phoneFieldObjects);
    });

    const addLeadFormDOM = $("#addLeadForm")
    addLeadFormDOM.submit(function (event) {
        event.preventDefault();
        let formData = {}
        addLeadFormDOM.serializeArray().forEach(({ name, value }) => name !== "phone_number" ? formData[name] = value : formData[name] = [...(formData[name] || [] ), value] )
        var numbers = [];
        for (let i = 0; i < phoneFieldObjects.length; i++) {
            numbers.push(phoneFieldObjects[i].getNumber())
        }
        formData["phone_number"] = numbers;
        console.log("formData",formData);
        $.ajax("/api/leads/update", {
        method: "POST",
        data: JSON.stringify(formData),
        contentType: "application/json",
        success: function (data) {
            // console.log("data", data)
            if (data.response_code == 200) {
                alert('Lead Edited Successfully')
                setTimeout(function () {// wait for 5 secs(2)
                location.reload(); // then reload the page.(3)
                }, 300);
            }
            else {}
        },
        error: function (error) {
            console.log(error, "error");

        }
        });
    });
        
</script>
{% endblock %}